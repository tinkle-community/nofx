# 订单簿分析指标使用说明

## 功能概述

已成功为项目添加订单簿(Order Book)分析功能。订单簿数据可以实时反映市场买卖压力,是技术分析的重要补充。

## 新增的指标

### 1. bid_volume_top5 (买单前5档总量)
- **定义**: 前5档买单的成交量之和
- **含义**: 反映买盘深度,数值越大表示买盘承接力越强

### 2. ask_volume_top5 (卖单前5档总量)
- **定义**: 前5档卖单的成交量之和
- **含义**: 反映卖盘深度,数值越大表示卖盘压力越强

### 3. imbalance (买卖不平衡度)
- **公式**: `(bid_volume_top5 - ask_volume_top5) / (bid_volume_top5 + ask_volume_top5)`
- **取值范围**: -1 到 1
- **解读**:
  - `> 0.1`: 买盘压力强劲,可能上涨 📈
  - `< -0.1`: 卖盘压力强劲,可能下跌 📉
  - `-0.1 ~ 0.1`: 买卖盘相对平衡 ⚖️

### 4. 其他辅助指标
- **BidPrice1**: 最优买价(买一价)
- **AskPrice1**: 最优卖价(卖一价)
- **Spread**: 买卖价差(绝对值)
- **SpreadPercent**: 买卖价差百分比(流动性指标)

## 代码实现位置

### 修改的文件
1. **market/data.go**
   - 新增 `OrderBookData` 结构体
   - 新增 `getOrderBookData()` 函数获取订单簿数据
   - 在 `Data` 结构体中添加 `OrderBook` 字段
   - 在 `Get()` 函数中调用订单簿数据获取
   - 在 `Format()` 函数中添加订单簿数据输出

### 数据流程
```
币安API订单簿 -> getOrderBookData() -> 计算指标 -> OrderBookData -> 包含在市场数据中 -> AI决策
```

## 使用方式

### 方式一: 通过 market.Get() 自动获取
```go
import "nofx/market"

// 获取市场数据(自动包含订单簿)
data, err := market.Get("BTCUSDT")
if err != nil {
    log.Fatal(err)
}

// 访问订单簿数据
if data.OrderBook != nil {
    fmt.Printf("买单量: %.2f\n", data.OrderBook.BidVolumeTop5)
    fmt.Printf("卖单量: %.2f\n", data.OrderBook.AskVolumeTop5)
    fmt.Printf("不平衡度: %.4f\n", data.OrderBook.Imbalance)
}
```

### 方式二: 查看格式化输出
```go
// 打印完整市场数据(包括订单簿)
fmt.Println(market.Format(data))
```

输出示例:
```
Order Book (Top 5 Levels):

Bid Volume (Top 5): 1250.50
Ask Volume (Top 5): 980.30
Imbalance: 0.1210 (Strong Buy Pressure)
Best Bid: 94498.5000 | Best Ask: 94501.0000
Spread: 2.5000 (0.0026%)
```

## 交易策略应用

### 1. 多空信号确认
将订单簿不平衡度与技术指标结合,提高信号准确性:

```go
// 强多头信号
if data.OrderBook.Imbalance > 0.1 &&  // 买盘强劲
   data.CurrentMACD > 0 &&             // MACD金叉
   data.CurrentRSI7 < 70 {             // RSI未超买
    // 开多单 - 三重确认
    fmt.Println("✅ 强买入信号")
}

// 强空头信号
if data.OrderBook.Imbalance < -0.1 && // 卖盘强劲
   data.CurrentMACD < 0 &&             // MACD死叉
   data.CurrentRSI7 > 30 {             // RSI未超卖
    // 开空单 - 三重确认
    fmt.Println("⚠️ 强卖出信号")
}
```

### 2. 趋势强度判断
```go
// 上涨趋势中,如果买盘持续强于卖盘,趋势更可靠
if data.PriceChange1h > 0 && data.OrderBook.Imbalance > 0.15 {
    fmt.Println("上涨趋势强劲,买盘支撑充足")
}

// 下跌趋势中,如果卖盘持续强于买盘,下跌可能延续
if data.PriceChange1h < 0 && data.OrderBook.Imbalance < -0.15 {
    fmt.Println("下跌趋势强劲,卖压持续")
}
```

### 3. 流动性检查
```go
// 检查市场流动性是否良好
if data.OrderBook.SpreadPercent < 0.05 {
    fmt.Println("✅ 流动性良好,适合交易")
} else if data.OrderBook.SpreadPercent > 0.1 {
    fmt.Println("⚠️ 流动性不足,谨慎交易")
}
```

## AI 决策整合

订单簿数据已经自动整合到AI决策流程中:

1. **自动获取**: `decision/engine.go` 中的 `fetchMarketDataForContext()` 会自动获取订单簿数据
2. **自动传递**: `buildUserPrompt()` 中通过 `market.Format()` 自动包含订单簿信息
3. **AI分析**: AI会根据订单簿数据(买卖压力)结合其他指标做出决策

AI可以看到的订单簿信息:
- 买单前5档总量
- 卖单前5档总量
- 不平衡度及其解读(强买压/强卖压/平衡)
- 最优买卖价
- 买卖价差

## 数据来源

- **API**: 币安合约 API
- **端点**: `https://fapi.binance.com/fapi/v1/depth`
- **参数**: `symbol=BTCUSDT&limit=5`
- **更新频率**: 实时(每次调用 `market.Get()` 时获取最新数据)

## 注意事项

1. **实时性**: 订单簿数据变化极快,反映的是调用时刻的市场状态
2. **深度限制**: 当前只分析前5档,如需更多档位可修改 `limit` 参数
3. **容错处理**: 如果API调用失败,会返回空值,不影响其他功能运行
4. **综合判断**: 不平衡度应与其他技术指标结合使用,不能单独作为交易依据
5. **市场类型**: 在流动性好的币种(如BTC/ETH)上效果更明显

## 运行测试

```bash
# 运行示例程序
cd /Users/atom/Develop/nofx/examples
go run orderbook_example.go
```

## 技术细节

### OrderBookData 结构体
```go
type OrderBookData struct {
    BidVolumeTop5 float64 // 买单前5档总量
    AskVolumeTop5 float64 // 卖单前5档总量
    Imbalance     float64 // 不平衡度
    BidPrice1     float64 // 买一价
    AskPrice1     float64 // 卖一价
    Spread        float64 // 价差
    SpreadPercent float64 // 价差百分比
}
```

### 计算公式
```go
// 买单量
bidVolumeTop5 = sum(bid[i].volume for i in 1..5)

// 卖单量
askVolumeTop5 = sum(ask[i].volume for i in 1..5)

// 不平衡度
imbalance = (bidVolumeTop5 - askVolumeTop5) / (bidVolumeTop5 + askVolumeTop5)

// 价差
spread = askPrice1 - bidPrice1
spreadPercent = (spread / bidPrice1) * 100
```

## 后续优化建议

1. **可配置深度**: 允许配置分析的档位数量(5/10/20档)
2. **历史追踪**: 保存历史订单簿数据,分析买卖压力变化趋势
3. **大单监控**: 识别订单簿中的大额挂单
4. **成交量加权**: 按价格距离对各档位进行加权计算
5. **实时推送**: 使用WebSocket获取实时订单簿更新

## 总结

订单簿分析功能已成功集成到项目中,可以:
- ✅ 实时获取买卖盘深度数据
- ✅ 计算买卖不平衡度
- ✅ 自动传递给AI进行决策
- ✅ 与技术指标结合使用
- ✅ 提高交易信号准确性

所有功能已经就绪,可以直接使用!

